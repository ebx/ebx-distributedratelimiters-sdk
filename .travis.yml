language: java
dist: trusty
sudo: false # faster builds

# safelist
branches:
  only:
  - master
  - dev

env:
  global:
    - DEV_BRANCH=dev
    - RELEASE_BRANCH=master
    - REPO=ebx/ebx-distributedratelimiters-sdk
    - NO_COLOUR='\033[0m'
    - RED_COLOUR='\033[0;31m'
    - GREEN_COLOUR='\033[0;32m'

before_script:
  - export SOURCE_BRANCH_NAME=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo $TRAVIS_PULL_REQUEST_BRANCH; fi) 
  - echo $GPG_SECRET_KEYS | base64 --decode | $GPG_EXECUTABLE --import || echo "Failed to import GPG_SECRET_KEYS (probably because this branch is a PR)."
  - echo $GPG_OWNERTRUST | base64 --decode | $GPG_EXECUTABLE --import-ownertrust || echo "Failed to import GPG_OWNERTRUST (probably because this branch is a PR)."
  - source Infrastructure/Build-Scripts/export_mvn_version.sh
  - source Infrastructure/Build-Scripts/validate_build.sh

script:
  - source Infrastructure/Build-Scripts/build_sdk_travis.sh
  
after_failure:
  - cat target/surefire-reports/*.txt

## Prepare the release for Github
## Ensure we have a suitable git tag for the release based on the verison number
before_deploy:
  # Set up git user name and tag this commit
  - git config --local user.name "MarcFletcher"
  - git config --local user.email "marc@echobox.com"
  - export DEPLOY_TAG=v$MVN_VERSION
  - git tag $DEPLOY_TAG
  
## Create the release in Github
deploy:
  provider: releases
  api_key:
    secure: aSrSoMxyqdSOYp5HR3O2FYIiDE9C1ThaBy5036YXoKNMs0XYyKJIIFN16MWXj8YTm6vFDPP/sMWfqWNoQGz57x/kphoJziDdsktZ/HjrVVyK3lz0hRQfSzNopSLN+9lx6N6xS/o6DWc8I8j9P2NDViAQexVU+37vfnAqPw/8DnThHaO3KYkUCIFRWKvNUSLBWbxrcDMpckelK93Zhfj2kFGA8FWvxpBEhw/OhmTfVZJGGsKlk0pF9drSrgd8bNgVs5JeUvO7JQkfQlDE3h9kphxKoE42KYax4IEviL6/CGgOMtOn3uE6gXzVslQwxhX+8M9Yea8QNipOata0yhCEppwYpBEiLYaAWZtyL11iL4hNb7s/eXwtsA2v8SS+Uq/YDKHwhiR0pLEyXsrfi6WfaYIBM0IT0a+oxMN9xvCe5cb0dBrQJwroDpaEg4D6xPS/NAy+rfav0G0EDKjte3X5FYDMdKCKUQjKXmXzI2kpnvEyfH8q6oZsskiF6H+IWMfPMwCsQTtCSY3yQNOwedbYmbZd6m1fuCX94PcjSm7UR+V9GZP2Xhqv7Z+79T94Whg4c/v3wlN/9qbYydb+Ob33khGtbcOk8Zgqza6nDdCt8OMqMbbl06fmJpNrUwH4oLjCyQw20C1zCJQmnWo88vOEobXokUrQ+DWtjqCHyjdbwxU=
  file: 
    - target/ebx-distributedratelimiters-sdk-parent-1.0.1.pom
    - DistributedRateLimiters/target/ebx-distributedratelimiters-sdk-$MVN_VERSION.jar
    - DistributedRateLimiters/target/ebx-distributedratelimiters-sdk-$MVN_VERSION-javadoc.jar
    - DistributedRateLimiters/target/ebx-distributedratelimiters-sdk-$MVN_VERSION-sources.jar
  edge: true
  on:
    repo: $REPO
    branch: $RELEASE_BRANCH
  name: v$MVN_VERSION
  
cache:
  directories:
    - ~/.m2/repository
